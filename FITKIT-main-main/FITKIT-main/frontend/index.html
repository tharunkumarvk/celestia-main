<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Food Analyzer</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Page management and navigation header */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .nav-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 35px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.06);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .button-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .toggle-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .message.success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .message.error {
            background: #fed7d7;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .result-item h4 {
            color: #4a5568;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .nutrition-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .nutrition-stat:last-child {
            border-bottom: none;
        }

        .confidence-bar {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            transition: width 0.5s ease;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        .content-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .meal-history-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .meal-history-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .google-signin {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
        }

        .connection-status.online {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .connection-status.offline {
            background: #fed7d7;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }

        /* Floating Chatbot Styles */
        .floating-chatbot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin: 0;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
        }

        .chatbot-toggle svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        .chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbot-window.active {
            display: flex;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8fafc;
        }

        .chatbot-input-area {
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .chatbot-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .chatbot-input:focus {
            outline: none;
            border-color: #48bb78;
        }

        .chatbot-send-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
        }

        .chatbot-send-btn:hover {
            transform: translateY(-1px);
        }

        .chatbot-message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .chatbot-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chatbot-message.bot {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .chatbot-message.system {
            background: #fef5e7;
            color: #ed8936;
            border: 1px solid #f6ad55;
            text-align: center;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .chatbot-window {
                width: 300px;
                height: 400px;
            }
            
            .floating-chatbot {
                bottom: 15px;
                right: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }

            .nav-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="connection-status offline" id="connection-status">Connecting...</div>

    <div class="container">
        <div class="nav-header hidden" id="nav-header">
            <div style="color: white;">
                <span id="current-user">Not logged in</span>
            </div>
            <div>
                <button onclick="showPage('dashboard')" class="button-secondary">Dashboard</button>
                <button onclick="showPage('analyze')" class="button-secondary">Analyze Food</button>
                <button onclick="showPage('history')" class="button-secondary">History</button>
                <button onclick="logout()" class="button-danger">Logout</button>
            </div>
        </div>

        <div class="page active" id="login-page">
            <div class="header">
                <h1>Smart Food Analyzer</h1>
                <p>AI-powered nutrition analysis with personalized recommendations</p>
            </div>

            <div class="card" id="user-card">
                <h3>Sign In</h3>
                <div class="google-signin">
                    <div id="g_id_onload"
                        data-client_id="710741263207-6c73gn9lsqt9b109dglhmis5r5nte9vd.apps.googleusercontent.com"
                        data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                        data-auto_prompt="false">
                    </div>

                    <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                        data-text="signin_with" data-size="large" data-logo_alignment="left">
                    </div>
                </div>
                <div id="user-message"></div>
            </div>
        </div>

        <div class="page" id="dashboard-page">
            <div class="header">
                <h1>Dashboard</h1>
                <p>Track your nutrition journey with detailed insights</p>
            </div>

            <!-- Today's Dashboard -->
            <div class="card" id="today-dashboard-card">
                <h3>ðŸ“… Today's Progress</h3>
                <div id="today-dashboard-content">
                    <p>Loading today's data...</p>
                </div>
            </div>

            <!-- Dashboard Tabs -->
            <div class="card">
                <div class="tabs">
                    <button class="tab active" id="daily-tab">Daily</button>
                    <button class="tab" id="weekly-tab">Weekly</button>
                    <button class="tab" id="monthly-tab">Monthly</button>
                    <button class="tab" id="goals-tab">Goals</button>
                    <button class="tab" id="profile-tab">Profile</button>
                </div>

                <!-- Daily Dashboard -->
                <div id="daily-dashboard" class="dashboard-content">
                    <h4>Daily Breakdown</h4>
                    <div id="daily-dashboard-content">
                        <p>Select a date to view daily breakdown</p>
                        <input type="date" id="daily-date-picker" style="margin: 10px 0;">
                        <button id="load-daily-btn" class="button-secondary">Load Daily Data</button>
                        <div id="daily-results"></div>
                    </div>
                </div>

                <!-- Weekly Dashboard -->
                <div id="weekly-dashboard" class="dashboard-content hidden">
                    <h4>Weekly Trends</h4>
                    <div id="weekly-dashboard-content">
                        <button id="load-weekly-btn" class="button-secondary">Load This Week</button>
                        <div id="weekly-results"></div>
                    </div>
                </div>

                <!-- Monthly Dashboard -->
                <div id="monthly-dashboard" class="dashboard-content hidden">
                    <h4>Monthly Analytics</h4>
                    <div id="monthly-dashboard-content">
                        <div style="margin: 10px 0;">
                            <select id="month-picker">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="year-picker">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                            <button id="load-monthly-btn" class="button-secondary">Load Monthly Data</button>
                        </div>
                        <div id="monthly-results"></div>
                    </div>
                </div>

                <!-- Goals Dashboard -->
                <div id="goals-dashboard" class="dashboard-content hidden">
                    <h4>Nutrition Goals</h4>
                    <div class="form-group">
                        <label>Daily Calorie Goal</label>
                        <input type="number" id="goal-calories" placeholder="2000" min="1000" max="5000">
                    </div>
                    <div class="form-group">
                        <label>Daily Protein Goal (g)</label>
                        <input type="number" id="goal-protein" placeholder="50" min="20" max="200">
                    </div>
                    <div class="form-group">
                        <label>Daily Carbs Goal (g)</label>
                        <input type="number" id="goal-carbs" placeholder="250" min="50" max="500">
                    </div>
                    <div class="form-group">
                        <label>Daily Fat Goal (g)</label>
                        <input type="number" id="goal-fat" placeholder="65" min="20" max="150">
                    </div>
                    <div class="form-group">
                        <label>Daily Fiber Goal (g)</label>
                        <input type="number" id="goal-fiber" placeholder="25" min="10" max="50">
                    </div>
                    <button id="save-goals-btn" class="button-secondary">Save Goals</button>
                </div>

                <!-- Profile Dashboard -->
                <div id="profile-dashboard" class="dashboard-content hidden">
                    <h4>Profile Settings</h4>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="gender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Dietary Preference</label>
                        <select id="diet_preference">
                            <option value="">Select Dietary Preference</option>
                            <option value="Vegetarian">Vegetarian</option>
                            <option value="Non-Vegetarian">Non-Vegetarian</option>
                            <option value="Vegan">Vegan</option>
                            <option value="Eggetarian">Eggetarian</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Goal</label>
                        <select id="goal">
                            <option value="">Select Goal</option>
                            <option value="Maintain Weight">Maintain Weight</option>
                            <option value="Lose Weight">Lose Weight</option>
                            <option value="Gain Weight">Gain Weight</option>
                            <option value="Build Muscle">Build Muscle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="activity">
                            <option value="">Select Activity Level</option>
                            <option value="Sedentary">Sedentary (little/no exercise)</option>
                            <option value="Lightly Active">Lightly Active (light exercise 1-3 days/week)</option>
                            <option value="Moderately Active">Moderately Active (moderate exercise 3-5 days/week)</option>
                            <option value="Active">Active (hard exercise 6-7 days/week)</option>
                            <option value="Very Active">Very Active (very hard exercise/training)</option>
                        </select>
                    </div>
                    <button id="save-profile-btn" class="button-secondary">Save Profile</button>
                </div>
            </div>
        </div>


        <div class="page" id="analyze-page">
            <div class="header">
                <h1>Food Analysis</h1>
                <p>Upload an image or describe your food for instant nutrition analysis</p>
            </div>

            <div class="card" id="analysis-card">
                <h3>Food Analysis</h3>
                <div class="tabs">
                    <button class="tab active" id="image-tab">Image Upload</button>
                    <button class="tab" id="text-tab">Text Input</button>
                </div>
                <div id="image-input">
                    <div class="form-group">
                        <label>Upload Food Image</label>
                        <input type="file" id="image-upload" accept="image/*">
                    </div>
                    <img id="image-preview" class="image-preview hidden">
                    <button id="analyze-btn" class="hidden button-secondary">Analyze Image</button>
                </div>
                <div id="text-input" class="hidden">
                    <div class="form-group">
                        <label>Enter Food Items</label>
                        <textarea id="dish-text"
                            placeholder="Enter dishes with quantities (e.g., 'chicken biryani 200g, mixed vegetable curry 150g, naan 2 pieces')"
                            rows="4"></textarea>
                    </div>
                    <button id="analyze-text-btn" class="button-secondary">Analyze Text</button>
                </div>
                <div id="upload-message"></div>
            </div>

            <div class="card hidden" id="loading-card">
                <div class="loading">
                    <div class="spinner"></div>
                    <span style="margin-left: 15px; font-weight: 600;">Analyzing your food...</span>
                </div>
            </div>

            <div class="card hidden" id="clarification-card">
                <h3>Clarification Questions</h3>
                <div id="questions-container"></div>
                <button id="submit-answers-btn" class="button-secondary">Submit Answers</button>
                <button id="skip-questions-btn" class="toggle-btn">Skip Questions</button>
                <div id="clarify-message"></div>
            </div>

            <div class="card hidden" id="results-card">
                <h3>Nutrition Results</h3>
                <div id="results-container"></div>
                <div style="margin-top: 30px;">
                    <button id="edit-results-btn" class="toggle-btn">Edit Results</button>
                    <button id="get-explanation-btn">Get Nutrition Insights</button>
                    <button id="get-recipe-btn" class="button-secondary">Generate Recipe</button>
                    <button id="get-meal-plan-btn" class="toggle-btn">Get Meal Plan</button>
                    <button id="export-pdf-btn" class="button-danger">Export PDF</button>
                    <button id="new-analysis-btn" class="button-danger">New Analysis</button>
                </div>
                <div id="explanation-section" class="content-section hidden">
                    <h4>Nutrition Insights</h4>
                    <div id="explanation-content"></div>
                </div>
                <div id="recipe-section" class="content-section hidden">
                    <h4>Recipe Suggestions</h4>
                    <div id="recipe-content"></div>
                    <div id="recipe-feedback-section" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #667eea;">
                        <h5 style="color: #667eea; margin-bottom: 10px;">Want to modify this recipe?</h5>
                        <div class="form-group">
                            <textarea id="recipe-feedback-input" placeholder="Tell me what you'd like to change... (e.g., 'make it spicier', 'I want something sweet instead', 'make it healthier', 'I don't have these ingredients')" rows="3" style="width: 100%; margin-bottom: 10px;"></textarea>
                            <button id="modify-recipe-btn" class="button-secondary">Modify Recipe</button>
                            <button id="recipe-satisfied-btn" class="toggle-btn">I'm Satisfied with This Recipe</button>
                        </div>
                        <div id="recipe-modification-status" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <div id="meal-plan-section" class="content-section hidden">
                    <div class="card" id="health-coach-card">
                        <h3>AI Health Coach</h3>
                        <div id="chat-messages"
                            style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8fafc;">
                        </div>
                        <div class="form-group">
                            <input type="text" id="chat-input" placeholder="Ask your health coach anything..."
                                style="margin-bottom: 10px;">
                            <button id="send-chat-btn" class="button-secondary">Send Message</button>
                            <button id="get-daily-tip-btn" class="toggle-btn">Get Daily Tip</button>
                        </div>
                    </div>

                    <div class="card" id="insights-card">
                        <h3>Your Health Insights</h3>
                        <div id="insights-container">
                            <p>Login and track some meals to see your personalized insights!</p>
                        </div>
                        <button id="refresh-insights-btn" class="button-secondary">Refresh Insights</button>
                    </div>
                    <h4>Personalized Meal Plan</h4>
                    <div id="meal-plan-content"></div>
                </div>
            </div>

            <div class="card hidden" id="edit-results-card">
                <h3>Edit Analysis Results</h3>
                <p style="margin-bottom: 20px; color: #718096;">Make corrections if the AI analysis doesn't look
                    accurate:</p>
                <div id="edit-container"></div>
                <div style="margin-top: 20px;">
                    <button id="save-edits-btn" class="button-secondary">Save Changes</button>
                    <button id="cancel-edits-btn" class="toggle-btn">Cancel</button>
                </div>
            </div>
        </div>

        <div class="page" id="history-page">
            <div class="header">
                <h1>Meal History</h1>
                <p>View your past food analyses and track your nutrition journey</p>
            </div>

            <div class="card" id="history-card">
                <h3>Meal History</h3>
                <div id="meal-history-container"></div>
            </div>
        </div>
    </div>

    <!-- Floating Chatbot -->
    <div class="floating-chatbot" id="floating-chatbot">
        <button class="chatbot-toggle" id="chatbot-toggle">
            <svg viewBox="0 0 24 24">
                <path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M6,9V7H18V9H6M14,11V13H6V11H14M16,15V17H6V15H16Z" />
            </svg>
        </button>
        <div class="chatbot-window" id="chatbot-window">
            <div class="chatbot-header">
                <span>ðŸ¤– AI Health Coach</span>
                <button onclick="toggleChatbot()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin: 0; padding: 0;">Ã—</button>
            </div>
            <div class="chatbot-messages" id="floating-chat-messages">
                <div class="chatbot-message bot">
                    <strong>Health Coach:</strong><br>
                    Hi! I'm your AI health coach. Ask me anything about nutrition, healthy eating, or your food choices! ðŸ¥—
                </div>
            </div>
            <div class="chatbot-input-area">
                <input type="text" class="chatbot-input" id="floating-chat-input" placeholder="Ask me about nutrition...">
                <button class="chatbot-send-btn" id="floating-chat-send">Send Message</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Configuration
        const GOOGLE_CLIENT_ID = "710741263207-6c73gn9lsqt9b109dglhmis5r5nte9vd.apps.googleusercontent.com"; // Replace with actual Google Client ID
        const BASE_URL = window.location.hostname === 'localhost'
            ? "http://localhost:8000"
            : "http://127.0.0.1:8000"; // Replace with your actual backend URL

        // Global variables
        let sessionId = null;
        let userId = null;
        let currentData = null;
        let connectionStatus = 'offline';

        // Health Coach Integration
        let chatHistory = [];

        document.getElementById("send-chat-btn").addEventListener("click", async () => {
            await sendChatMessage();
        });

        document.getElementById("chat-input").addEventListener("keypress", async (e) => {
            if (e.key === 'Enter') {
                await sendChatMessage();
            }
        });

        document.getElementById("get-daily-tip-btn").addEventListener("click", async () => {
            if (connectionStatus === 'offline') {
                showMessage("system", "This feature requires an internet connection", true);
                return;
            }
            if (!userId) {
                showMessage("system", "Please login first to get personalized tips", true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/agent/daily_tip/${userId}`);
                if (!response.ok) {
                    throw new Error(`Daily tip failed: ${response.status}`);
                }

                const data = await response.json();
                addChatMessage("Health Coach", data.tip, "coach");
            } catch (error) {
                console.error("Daily tip error:", error);
                showMessage("system", "Failed to get daily tip: " + error.message, true);
            }
        });

        document.getElementById("refresh-insights-btn").addEventListener("click", async () => {
            await loadUserInsights();
        });

        async function sendChatMessage() {
            const input = document.getElementById("chat-input");
            const message = input.value.trim();

            if (!message) return;

            if (connectionStatus === 'offline') {
                showMessage("system", "This feature requires an internet connection", true);
                return;
            }

            input.value = "";
            addChatMessage("You", message, "user");

            try {
                const context = {
                    user_id: userId,
                    current_analysis: currentData?.analysis_data || null,
                    chat_history: chatHistory.slice(-5) // Last 5 exchanges
                };

                const response = await fetch(`${BASE_URL}/agent/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: message,
                        context: context
                    })
                });

                if (!response.ok) {
                    throw new Error(`Chat failed: ${response.status}`);
                }

                const data = await response.json();
                addChatMessage("Health Coach", data.response, "coach");

                // Update chat history
                chatHistory.push({
                    user: message,
                    agent: data.response
                });

                // Keep only last 10 exchanges
                if (chatHistory.length > 10) {
                    chatHistory = chatHistory.slice(-10);
                }
            } catch (error) {
                console.error("Chat error:", error);
                addChatMessage("Health Coach", "Sorry, I'm having trouble responding right now. Please try again.", "error");
            }
        }

        function addChatMessage(sender, message, type) {
            const container = document.getElementById("chat-messages");
            const messageDiv = document.createElement("div");

            const senderColor = type === "user" ? "#667eea" : type === "error" ? "#e53e3e" : "#48bb78";
            const bgColor = type === "user" ? "#f0f4ff" : type === "error" ? "#fed7d7" : "#f0fff4";

            messageDiv.style.cssText = `
                margin-bottom: 10px; 
                padding: 10px; 
                border-radius: 8px; 
                background: ${bgColor};
                border-left: 3px solid ${senderColor};
            `;

            messageDiv.innerHTML = `
                <strong style="color: ${senderColor};">${sender}:</strong><br>
                <span style="white-space: pre-wrap;">${message}</span>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function loadUserInsights() {
            if (connectionStatus === 'offline') {
                showMessage("system", "This feature requires an internet connection", true);
                return;
            }
            if (!userId) {
                document.getElementById("insights-container").innerHTML = "<p>Please login first to see your insights</p>";
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/agent/insights/${userId}`);
                if (!response.ok) {
                    throw new Error(`Insights failed: ${response.status}`);
                }

                const data = await response.json();
                displayInsights(data);
            } catch (error) {
                console.error("Insights error:", error);
                document.getElementById("insights-container").innerHTML = "<p>Failed to load insights. Please try again.</p>";
            }
        }

        function displayInsights(insights) {
            const container = document.getElementById("insights-container");
            let html = "";

            if (insights.weekly_stats && Object.keys(insights.weekly_stats).length > 0) {
                const stats = insights.weekly_stats;
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Weekly Statistics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div><strong>Avg Calories:</strong> ${stats.avg_daily_calories || 'N/A'}</div>
                            <div><strong>Avg Protein:</strong> ${stats.avg_daily_protein || 'N/A'}g</div>
                            <div><strong>Avg Carbs:</strong> ${stats.avg_daily_carbs || 'N/A'}g</div>
                            <div><strong>Avg Fat:</strong> ${stats.avg_daily_fat || 'N/A'}g</div>
                            <div><strong>Meals Tracked:</strong> ${stats.meals_tracked || 0}</div>
                        </div>
                    </div>
                `;
            }

            if (insights.motivational_message) {
                html += `
                    <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 8px;">Motivation</h4>
                        <p style="margin: 0;">${insights.motivational_message}</p>
                    </div>
                `;
            }

            if (insights.recommendations && insights.recommendations.length > 0) {
                html += `
                    <div style="background: #fef5e7; padding: 15px; border-radius: 8px; border-left: 3px solid #ed8936;">
                        <h4 style="color: #ed8936; margin-bottom: 10px;">Recommendations</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${insights.recommendations.map(rec => `<li style="margin-bottom: 5px;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (!html) {
                html = "<p>Track some meals to see your personalized insights!</p>";
            }

            container.innerHTML = html;
        }

        // Update Google Client ID in the HTML
        document.getElementById('g_id_onload').setAttribute('data-client_id', GOOGLE_CLIENT_ID);

        // Connection management
        async function testConnection() {
            try {
                const response = await fetch(`${BASE_URL}/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    timeout: 5000
                });

                if (response.ok) {
                    connectionStatus = 'online';
                    updateConnectionStatus();
                    return true;
                } else {
                    throw new Error(`Server responded with ${response.status}`);
                }
            } catch (error) {
                connectionStatus = 'offline';
                updateConnectionStatus();
                showMessage("system", "Cannot connect to server. Please check your connection.", true);
                return false;
            }
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            if (connectionStatus === 'online') {
                statusEl.textContent = 'Connected';
                statusEl.className = 'connection-status online';
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'connection-status offline';
            }
        }

        // Google Sign-In Handler
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);

            createGoogleUser({
                google_id: responsePayload.sub,
                email: responsePayload.email,
                name: responsePayload.name,
                picture: responsePayload.picture
            });
        }

        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        async function createGoogleUser(userData) {
            if (connectionStatus === 'offline') {
                showMessage("user", "Cannot sign in while offline. Please check your connection.", true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/users/google`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    throw new Error(`Authentication failed: ${response.status}`);
                }

                const user = await response.json();
                userId = user.id;
                localStorage.setItem('userId', userId);
                document.getElementById('current-user').textContent = userData.name || userData.email;
                showMessage("user", `Welcome, ${userData.name || userData.email}!`, false);

                setTimeout(() => showPage('dashboard'), 300);
                loadProfile(user.profile);
                getMealHistory();
            } catch (error) {
                console.error("Google auth error:", error);
                showMessage("user", "Authentication failed: " + error.message, true);
            }
        }

        // Session Management
        async function initSession() {
            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot create session while offline", true);
                return false;
            }

            try {
                console.log("Creating session...");
                const response = await fetch(`${BASE_URL}/sessions/`, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`Session creation failed: ${response.status}`);
                }

                const data = await response.json();
                sessionId = data.session_id;
                localStorage.setItem('sessionId', sessionId);
                console.log("Session ID:", sessionId);
                return true;
            } catch (error) {
                console.error("Session creation error:", error);
                showMessage("system", "Failed to create session: " + error.message, true);
                return false;
            }
        }

        // Profile Management
        function loadProfile(profile) {
            if (profile) {
                document.getElementById("gender").value = profile.gender || "";
                document.getElementById("diet_preference").value = profile.diet_preference || "";
                document.getElementById("goal").value = profile.goal || "";
                document.getElementById("activity").value = profile.activity || "";
            }
        }

        function getCurrentProfile() {
            return {
                gender: document.getElementById("gender").value || "",
                diet_preference: document.getElementById("diet_preference").value || "",
                goal: document.getElementById("goal").value || "",
                activity: document.getElementById("activity").value || ""
            };
        }

        // Save Profile
        document.getElementById("save-profile-btn").addEventListener("click", async () => {
            if (!userId) {
                showMessage("system", "Please login first", true);
                return;
            }

            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot save profile while offline", true);
                return;
            }

            const profile = getCurrentProfile();

            try {
                const response = await fetch(`${BASE_URL}/users/${userId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(profile)
                });

                if (!response.ok) {
                    throw new Error(`Profile update failed: ${response.status}`);
                }

                showMessage("system", "Profile saved successfully!", false);
            } catch (error) {
                console.error("Profile save error:", error);
                showMessage("system", "Profile save failed: " + error.message, true);
            }
        });

        // Meal History
        async function getMealHistory() {
            if (!userId || connectionStatus === 'offline') return;

            try {
                const response = await fetch(`${BASE_URL}/users/${userId}/meals`);

                if (!response.ok) {
                    throw new Error(`History fetch failed: ${response.status}`);
                }

                const meals = await response.json();
                const container = document.getElementById("meal-history-container");
                container.innerHTML = "";

                if (meals.length === 0) {
                    container.innerHTML = "<p>No meal history found. Start analyzing some food!</p>";
                    return;
                }

                meals.forEach((meal, index) => {
                    const div = document.createElement("div");
                    div.className = "meal-history-item";

                    const totalCalories = meal.analysis_data?.total_calories || 'N/A';
                    const itemCount = meal.analysis_data?.items?.length || 0;
                    const date = meal.created_at ? new Date(meal.created_at).toLocaleDateString() : 'Unknown';

                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>Meal #${meal.id}</strong>
                            <div>
                                <span style="color: #667eea; font-weight: 600;">${totalCalories} calories</span>
                                <span style="margin-left: 15px; color: #718096; font-size: 0.9em;">${date}</span>
                            </div>
                        </div>
                        <p>${itemCount} items analyzed</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #667eea;">View Details</summary>
                            <div style="margin-top: 10px; background: #f8fafc; padding: 15px; border-radius: 8px;">
                                <h5>Items:</h5>
                                <ul style="margin: 5px 0;">
                                    ${meal.analysis_data?.items?.map(item => `
                                        <li>
                                            ${item.name}
                                            ${item.quantity ? `(${item.quantity})` : ''} -
                                            ${item.calories || 'N/A'} cal
                                            ${item.is_vegetarian !== undefined ? (item.is_vegetarian ? ' ðŸ¥¬' : ' ðŸ¥©') : ''}
                                        </li>
                                    `).join('') || '<li>No items</li>'}
                                </ul>
                            </div>
                        </details>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error("History error:", error);
                showMessage("system", "Failed to load meal history", true);
            }
        }

        // Tab Management
        document.getElementById("image-tab").addEventListener("click", () => {
            document.getElementById("image-tab").classList.add("active");
            document.getElementById("text-tab").classList.remove("active");
            document.getElementById("image-input").classList.remove("hidden");
            document.getElementById("text-input").classList.add("hidden");
        });

        document.getElementById("text-tab").addEventListener("click", () => {
            document.getElementById("text-tab").classList.add("active");
            document.getElementById("image-tab").classList.remove("active");
            document.getElementById("text-input").classList.remove("hidden");
            document.getElementById("image-input").classList.add("hidden");
        });

        // Image Upload
        document.getElementById("image-upload").addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot upload while offline", true);
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showMessage("system", "Please select a valid image file", true);
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showMessage("system", "Image too large. Please select an image smaller than 10MB", true);
                return;
            }

            // Show preview
            const img = document.getElementById("image-preview");
            img.src = URL.createObjectURL(file);
            img.classList.remove("hidden");
            document.getElementById("analyze-btn").classList.remove("hidden");

            // Upload image
            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(`${BASE_URL}/analysis/upload/${sessionId}`, {
                    method: "POST",
                    body: formData
                });

                if (response.status === 404) {
                    sessionId = null;
                    localStorage.removeItem('sessionId');
                    showMessage("system", "Session expired. Creating new session...", false);
                    const success = await initSession();
                    if (success) {
                        // Retry upload
                        const retryResponse = await fetch(`${BASE_URL}/analysis/upload/${sessionId}`, {
                            method: "POST",
                            body: formData
                        });
                        if (!retryResponse.ok) {
                            throw new Error('Retry upload failed: ' + retryResponse.status);
                        }
                        showMessage("system", "Image uploaded successfully!", false);
                    }
                    return;
                }

                if (!response.ok) {
                    throw new Error('Upload failed: ' + response.status);
                }

                showMessage("system", "Image uploaded successfully!", false);
            } catch (error) {
                console.error("Upload error:", error);
                showMessage("system", "Upload failed: " + error.message, true);
                document.getElementById("analyze-btn").classList.add("hidden");
            }
        });

        // Analysis Functions
        document.getElementById("analyze-btn").addEventListener("click", async () => {
            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot analyze while offline", true);
                return;
            }

            showLoadingState(true);
            try {
                let url = `${BASE_URL}/analysis/analyze/${sessionId}`;
                if (userId) url += `?user_id=${userId}`;

                const response = await fetch(url, { method: "POST" });

                if (response.status === 404) {
                    sessionId = null;
                    localStorage.removeItem('sessionId');
                    showMessage("system", "Session expired. Please upload the image again.", true);
                    resetUI();
                    await initSession();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Analysis failed: ' + response.status);
                }

                const data = await response.json();
                handleAnalysisResponse(data);
            } catch (error) {
                console.error("Analysis error:", error);
                showMessage("system", "Analysis failed: " + error.message, true);
                showLoadingState(false);
            }
        });

        document.getElementById("analyze-text-btn").addEventListener("click", async () => {
            const text = document.getElementById("dish-text").value.trim();

            if (!text) {
                showMessage("system", "Please enter some food items first", true);
                return;
            }

            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot analyze while offline", true);
                return;
            }

            showLoadingState(true);

            try {
                let url = `${BASE_URL}/analysis/analyze_text/${sessionId}`;
                if (userId) url += `?user_id=${userId}`;

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) {
                    throw new Error('Text analysis failed: ' + response.status);
                }

                const data = await response.json();
                handleAnalysisResponse(data);
            } catch (error) {
                console.error("Text analysis error:", error);
                showMessage("system", "Text analysis failed: " + error.message, true);
                showLoadingState(false);
            }
        });

        function handleAnalysisResponse(data) {
            showLoadingState(false);
            console.log("Analysis response:", data);

            if (data.questions && data.questions.length > 0) {
                showQuestions(data.questions);
                document.getElementById("clarification-card").classList.remove("hidden");
            } else if (data.data && data.data.analysis_data) {
                currentData = data.data;
                showResults(data.data.analysis_data);
                document.getElementById("results-card").classList.remove("hidden");
            } else if (data.message && data.message.includes("no food detected")) {
                showMessage("system", "No food detected in the image. Please try a clearer photo or describe the food using text input.", true);
            } else {
                showMessage("system", "Analysis completed but no data received", true);
                console.error("Unexpected response format:", data);
            }
        }

        function showQuestions(questions) {
            const container = document.getElementById("questions-container");
            container.innerHTML = "";

            questions.forEach((question, index) => {
                const questionDiv = document.createElement("div");
                questionDiv.className = "form-group";
                questionDiv.innerHTML = `
                    <label><strong>Question ${index + 1}:</strong> ${question}</label>
                    <input type="text" id="answer-${index}" placeholder="Your answer here..." required>
                `;
                container.appendChild(questionDiv);
            });
        }

        document.getElementById("submit-answers-btn").addEventListener("click", async () => {
            const inputs = document.querySelectorAll('#questions-container input');
            const answers = Array.from(inputs).map(input => input.value.trim());

            if (answers.some(answer => !answer)) {
                showMessage("system", "Please answer all questions before submitting", true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/analysis/refine/${sessionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(answers)
                });

                if (!response.ok) {
                    throw new Error(`Refinement failed: ${response.status}`);
                }

                const data = await response.json();
                currentData = data.data;

                document.getElementById("clarification-card").classList.add("hidden");
                showResults(data.data.analysis_data);
                document.getElementById("results-card").classList.remove("hidden");
            } catch (error) {
                console.error("Refinement error:", error);
                showMessage("system", "Failed to refine analysis: " + error.message, true);
            }
        });

        document.getElementById("skip-questions-btn").addEventListener("click", async () => {
            try {
                const response = await fetch(`${BASE_URL}/analysis/skip_clarification/${sessionId}`, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`Skip failed: ${response.status}`);
                }

                const data = await response.json();
                currentData = data.data;

                document.getElementById("clarification-card").classList.add("hidden");

                // Get results from session
                const resultsResponse = await fetch(`${BASE_URL}/analysis/results/${sessionId}`);
                if (resultsResponse.ok) {
                    const resultsData = await resultsResponse.json();
                    showResults(resultsData);
                    document.getElementById("results-card").classList.remove("hidden");
                }
            } catch (error) {
                console.error("Skip error:", error);
                showMessage("system", "Failed to skip questions: " + error.message, true);
            }
        });

        function showResults(data) {
            const container = document.getElementById("results-container");
            container.innerHTML = "";

            if (!data || !data.items || data.items.length === 0) {
                container.innerHTML = "<p>No analysis data available</p>";
                return;
            }

            const resultsGrid = document.createElement("div");
            resultsGrid.className = "results-grid";

            // Individual items
            data.items.forEach((item, index) => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "result-item";
                itemDiv.innerHTML = `
                    <h4>${item.name}</h4>
                    <p><strong>Quantity:</strong> ${item.quantity}</p>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${item.confidence}%"></div>
                    </div>
                    <p style="font-size: 0.9em; color: #718096;">Confidence: ${item.confidence}%</p>
                    <div style="margin-top: 15px;">
                        <div class="nutrition-stat">
                            <span>Calories:</span>
                            <strong>${item.calories || 'N/A'}</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Protein:</span>
                            <strong>${item.protein || 'N/A'}g</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Carbs:</span>
                            <strong>${item.carbs || 'N/A'}g</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Fat:</span>
                            <strong>${item.fat || 'N/A'}g</strong>
                        </div>
                    </div>
                `;
                resultsGrid.appendChild(itemDiv);
            });

            // Total summary
            const totalDiv = document.createElement("div");
            totalDiv.className = "result-item";
            totalDiv.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
            totalDiv.style.color = "white";
            totalDiv.innerHTML = `
                <h4>Total Nutrition</h4>
                <div style="margin-top: 15px;">
                    <div class="nutrition-stat" style="border-color: rgba(255,255,255,0.3);">
                        <span>Total Calories:</span>
                        <strong>${data.total_calories || 'N/A'}</strong>
                    </div>
                    <div class="nutrition-stat" style="border-color: rgba(255,255,255,0.3);">
                        <span>Total Protein:</span>
                        <strong>${data.total_protein || 'N/A'}g</strong>
                    </div>
                    <div class="nutrition-stat" style="border-color: rgba(255,255,255,0.3);">
                        <span>Total Carbs:</span>
                        <strong>${data.total_carbs || 'N/A'}g</strong>
                    </div>
                    <div class="nutrition-stat" style="border-color: rgba(255,255,255,0.3);">
                        <span>Total Fat:</span>
                        <strong>${data.total_fat || 'N/A'}g</strong>
                    </div>
                </div>
            `;
            resultsGrid.appendChild(totalDiv);

            // Add recommendations if available
            if (currentData && currentData.recommendations && currentData.recommendations.swaps) {
                const swapsDiv = document.createElement("div");
                swapsDiv.className = "result-item";
                swapsDiv.style.background = "linear-gradient(135deg, #48bb78 0%, #38a169 100%)";
                swapsDiv.style.color = "white";
                swapsDiv.innerHTML = `
                    <h4>Healthy Swaps</h4>
                    <div style="margin-top: 15px;">
                        ${currentData.recommendations.swaps.slice(0, 3).map(swap => `
                            <div style="margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                <strong>${swap.original}</strong> â†’ ${swap.swap}<br>
                                <small style="opacity: 0.9;">${swap.reason}</small>
                            </div>
                        `).join('')}
                    </div>
                `;
                resultsGrid.appendChild(swapsDiv);
            }

            container.appendChild(resultsGrid);
        }

        // Additional Feature Buttons
        document.getElementById("get-explanation-btn").addEventListener("click", async () => {
            if (!sessionId || connectionStatus === 'offline') return;

            try {
                const response = await fetch(`${BASE_URL}/analysis/explanation/${sessionId}`);
                if (!response.ok) {
                    throw new Error(`Explanation failed: ${response.status}`);
                }

                const data = await response.json();
                document.getElementById("explanation-content").innerHTML = formatMarkdown(data.explanation);
                document.getElementById("explanation-section").classList.remove("hidden");
            } catch (error) {
                console.error("Explanation error:", error);
                showMessage("system", "Failed to get nutrition insights: " + error.message, true);
            }
        });

        document.getElementById("get-recipe-btn").addEventListener("click", async () => {
            if (!currentData || !currentData.analysis_data || connectionStatus === 'offline') {
                showMessage("system", "No analysis data available for recipe generation", true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/recommendations/recipe`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(currentData.analysis_data)
                });

                if (!response.ok) {
                    throw new Error(`Recipe generation failed: ${response.status}`);
                }

                const data = await response.json();
                document.getElementById("recipe-content").innerHTML = formatMarkdown(data.recipe);
                document.getElementById("recipe-section").classList.remove("hidden");
            } catch (error) {
                console.error("Recipe error:", error);
                showMessage("system", "Failed to generate recipe: " + error.message, true);
            }
        });

        document.getElementById("get-meal-plan-btn").addEventListener("click", async () => {
            if (!userId) {
                showMessage("system", "Please login first to get a personalized meal plan", true);
                return;
            }

            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot generate meal plan while offline", true);
                return;
            }

            try {
                const profile = getCurrentProfile();
                const response = await fetch(`${BASE_URL}/recommendations/meal_plan/${userId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(profile)
                });

                if (!response.ok) {
                    throw new Error(`Meal plan generation failed: ${response.status}`);
                }

                const data = await response.json();
                document.getElementById("meal-plan-content").innerHTML = formatMarkdown(data.plan);
                document.getElementById("meal-plan-section").classList.remove("hidden");
            } catch (error) {
                console.error("Meal plan error:", error);
                showMessage("system", "Failed to generate meal plan: " + error.message, true);
            }
        });

        document.getElementById("export-pdf-btn").addEventListener("click", () => {
            if (!currentData) {
                showMessage("system", "No data available to export", true);
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text("Smart Food Analyzer Report", 20, 30);

                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);

                doc.setFontSize(10);
                const content = JSON.stringify(currentData, null, 2);
                const lines = doc.splitTextToSize(content, 170);
                doc.text(lines, 20, 60);

                doc.save(`food-analysis-${Date.now()}.pdf`);
                showMessage("system", "PDF exported successfully!", false);
            } catch (error) {
                console.error("PDF export error:", error);
                showMessage("system", "Failed to export PDF: " + error.message, true);
            }
        });

        document.getElementById("new-analysis-btn").addEventListener("click", async () => {
            try {
                if (sessionId) {
                    await fetch(`${BASE_URL}/sessions/${sessionId}`, { method: "DELETE" });
                }
                resetUI();
                const success = await initSession();
                if (success) {
                    showMessage("system", "Ready for new analysis!", false);
                }
            } catch (error) {
                console.error("New analysis error:", error);
                showMessage("system", "Failed to start new analysis: " + error.message, true);
            }
        });

        // Utility Functions
        function resetUI() {
            document.getElementById("image-upload").value = "";
            document.getElementById("dish-text").value = "";
            document.getElementById("image-preview").classList.add("hidden");
            document.getElementById("analyze-btn").classList.add("hidden");

            document.getElementById("results-container").innerHTML = "";
            document.getElementById("explanation-content").innerHTML = "";
            document.getElementById("recipe-content").innerHTML = "";
            document.getElementById("meal-plan-content").innerHTML = "";
            document.getElementById("questions-container").innerHTML = "";

            document.getElementById("loading-card").classList.add("hidden");
            document.getElementById("clarification-card").classList.add("hidden");
            document.getElementById("results-card").classList.add("hidden");
            document.getElementById("edit-results-card").classList.add("hidden");
            document.getElementById("explanation-section").classList.add("hidden");
            document.getElementById("recipe-section").classList.add("hidden");
            document.getElementById("meal-plan-section").classList.add("hidden");
            currentData = null;
            sessionId = null;

            document.getElementById("image-tab").classList.add("active");
            document.getElementById("text-tab").classList.remove("active");
            document.getElementById("image-input").classList.remove("hidden");
            document.getElementById("text-input").classList.add("hidden");
        }

        function formatMarkdown(text) {
            if (!text) return "";

            return text
                .replace(/## (.*)/g, '<h4 style="color: #4a5568; margin: 20px 0 10px 0; font-size: 1.2em;">$1</h4>')
                .replace(/### (.*)/g, '<h5 style="color: #667eea; margin: 15px 0 8px 0; font-size: 1.1em;">$1</h5>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*$)/gm, '<li style="margin-bottom: 5px;">$1</li>')
                .replace(/\n\n/g, '</p><p style="margin-bottom: 10px;">')
                .replace(/\n/g, '<br>')
                .replace(/^(.*)$/, '<p style="margin-bottom: 10px;">$1</p>');
        }

        function showMessage(section, message, isError) {
            const toast = document.createElement('div');
            toast.innerHTML = `
                <div style="padding: 15px; margin: 10px; border-radius: 8px; position: fixed; top: 60px; right: 20px; z-index: 1001; max-width: 400px; background: ${isError ? '#fed7d7' : '#f0fff4'}; color: ${isError ? '#e53e3e' : '#38a169'}; border: 1px solid ${isError ? '#feb2b2' : '#9ae6b4'}; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    ${message}
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-left: 10px; background: none; border: none; font-size: 16px; cursor: pointer; float: right;">Ã—</button>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');

            if (pageId !== 'login') {
                document.getElementById('nav-header').classList.remove('hidden');
                if (pageId === 'dashboard' && userId) {
                    loadUserInsights();
                    // Clear chat on dashboard load
                    document.getElementById("chat-messages").innerHTML = "";
                    addChatMessage("Health Coach", "Hi! I'm your AI health coach. Ask me anything about nutrition or your eating habits!", "coach");
                }
                if (pageId === 'history') {
                    getMealHistory();
                }
            } else {
                document.getElementById('nav-header').classList.add('hidden');
            }
        }

        function logout() {
            userId = null;
            sessionId = null;
            localStorage.removeItem('userId');
            localStorage.removeItem('sessionId');
            document.getElementById('current-user').textContent = 'Not logged in';
            document.getElementById('nav-header').classList.add('hidden');
            showPage('login');
            resetUI();
        }

        function showLoadingState(show) {
            if (show) {
                document.getElementById("loading-card").classList.remove("hidden");
                document.getElementById("clarification-card").classList.add("hidden");
                document.getElementById("results-card").classList.add("hidden");
            } else {
                document.getElementById("loading-card").classList.add("hidden");
            }
        }

        // Edit Results Functionality - Replace all edit-related functions
        document.getElementById("edit-results-btn").addEventListener("click", () => {
            if (!currentData || !currentData.analysis_data) {
                showMessage("system", "No analysis data available to edit", true);
                return;
            }
            showEditResults(currentData.analysis_data);
        });

        function showEditResults(data) {
            const container = document.getElementById("edit-container");
            container.innerHTML = "";

            if (!data.items || data.items.length === 0) {
                container.innerHTML = "<p>No items to edit</p>";
                return;
            }

            data.items.forEach((item, index) => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "form-group";
                itemDiv.style.border = "1px solid #e2e8f0";
                itemDiv.style.padding = "15px";
                itemDiv.style.borderRadius = "8px";
                itemDiv.style.marginBottom = "15px";

                itemDiv.innerHTML = `
            <h5 style="margin-bottom: 15px; color: #4a5568;">Item ${index + 1}</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label>Food Name:</label>
                    <input type="text" id="edit-name-${index}" value="${item.name}" style="margin-bottom: 10px;">
                </div>
                <div>
                    <label>Quantity/Serving Size:</label>
                    <input type="text" id="edit-quantity-${index}" value="${item.quantity}" style="margin-bottom: 10px;">
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Preparation Method/Additional Details:</label>
                <textarea id="edit-details-${index}" placeholder="e.g., fried, grilled, with oil, steamed, etc." rows="2" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px;">${item.preparation || ''}</textarea>
            </div>
            <p style="color: #718096; font-size: 0.9em; font-style: italic;">Note: Click "Get Refined Analysis" after saving to recalculate nutrition with your corrections.</p>
        `;
                container.appendChild(itemDiv);
            });

            // Add refined analysis button
            const buttonDiv = document.createElement("div");
            buttonDiv.style.marginTop = "20px";
            buttonDiv.innerHTML = `
        <button id="get-refined-btn" class="toggle-btn" style="margin-right: 10px;">Get Refined Analysis</button>
    `;
            container.appendChild(buttonDiv);

            document.getElementById("edit-results-card").classList.remove("hidden");

            // Add event listener for refined analysis
            document.getElementById("get-refined-btn").addEventListener("click", async () => {
                await getRefinedAnalysis();
            });
        }

        document.getElementById("save-edits-btn").addEventListener("click", () => {
            if (!currentData || !currentData.analysis_data) return;

            const data = currentData.analysis_data;
            let hasChanges = false;

            // Update items with edited information (but keep original nutrition values)
            data.items.forEach((item, index) => {
                const nameEl = document.getElementById(`edit-name-${index}`);
                const quantityEl = document.getElementById(`edit-quantity-${index}`);
                const detailsEl = document.getElementById(`edit-details-${index}`);

                if (nameEl && quantityEl && detailsEl) {
                    const newName = nameEl.value.trim();
                    const newQuantity = quantityEl.value.trim();
                    const newDetails = detailsEl.value.trim();

                    // Check if anything changed
                    if (newName !== item.name || newQuantity !== item.quantity || newDetails !== (item.preparation || '')) {
                        hasChanges = true;
                    }

                    // Update all descriptive fields, even if empty
                    item.name = newName;
                    item.quantity = newQuantity;
                    item.preparation = newDetails;
                }
            });

            if (!hasChanges) {
                showMessage("system", "No changes detected", false);
                document.getElementById("edit-results-card").classList.add("hidden");
                return;
            }

            // Update current data
            currentData.analysis_data = data;

            // Show success message
            showMessage("system", "Changes saved! Click 'Get Refined Analysis' to recalculate nutrition based on your corrections.", false);

            // Log the meal with updated data if user is logged in
            if (userId) {
                logUpdatedMeal();
            }
        });

        async function getRefinedAnalysis() {
            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot get refined analysis while offline", true);
                return;
            }

            if (!currentData || !currentData.analysis_data) {
                showMessage("system", "No analysis data available", true);
                return;
            }

            try {
                showMessage("system", "Getting refined analysis based on your corrections...", false);

                // Create refined text from edited items
                const refinedText = currentData.analysis_data.items.map((item, idx) => {
                    const prep = item.preparation ? ` (${item.preparation})` : '';
                    return `${item.name} - ${item.quantity}${prep}`;
                }).join(', ');

                // Use existing session's refine functionality
                const questions = ["What are the corrected food items with quantities?"];
                const answers = [refinedText];

                const response = await fetch(`${BASE_URL}/analysis/refine/${sessionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(answers)
                });

                if (!response.ok) {
                    throw new Error(`Refinement failed: ${response.status}`);
                }

                const data = await response.json();

                if (data.data && data.data.analysis_data) {
                    currentData = data.data;

                    // Hide edit card and refresh results
                    document.getElementById("edit-results-card").classList.add("hidden");
                    showResults(data.data.analysis_data);
                    showMessage("system", "Analysis refined successfully with your corrections!", false);

                    // Log the refined meal
                    if (userId) {
                        logUpdatedMeal();
                    }
                } else {
                    showMessage("system", "Refinement completed but no new data received", false);
                }

            } catch (error) {
                console.error("Refinement error:", error);
                showMessage("system", "Failed to get refined analysis. Please try again.", true);
            }
        }

        document.getElementById("cancel-edits-btn").addEventListener("click", () => {
            document.getElementById("edit-results-card").classList.add("hidden");
        });

        async function logUpdatedMeal() {
            if (!userId || !currentData || connectionStatus === 'offline') return;

            try {
                // Note: This assumes you have a meal logging endpoint, otherwise it will just log to console
                console.log("Updated meal data:", currentData);

                // If you want to save to database, you can add this:
                /*
                const response = await fetch(`${BASE_URL}/users/${userId}/log_meal`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        analysis_data: currentData.analysis_data,
                        portion_estimates: currentData.portion_estimates || {},
                        nutrition_summary: currentData.nutrition_summary || {},
                        recommendations: currentData.recommendations || {}
                    })
                });
                */
            } catch (error) {
                console.error("Failed to log updated meal:", error);
            }
        }

        // Recipe Feedback Loop
        let currentRecipe = "";
        let recipeModificationCount = 0;

        document.getElementById("modify-recipe-btn").addEventListener("click", async () => {
            const feedback = document.getElementById("recipe-feedback-input").value.trim();
            
            if (!feedback) {
                showMessage("system", "Please tell me what you'd like to change about the recipe", true);
                return;
            }

            if (connectionStatus === 'offline') {
                showMessage("system", "Cannot modify recipe while offline", true);
                return;
            }

            if (!currentData || !currentData.analysis_data) {
                showMessage("system", "No analysis data available for recipe modification", true);
                return;
            }

            try {
                document.getElementById("recipe-modification-status").innerHTML = `
                    <div style="display: flex; align-items: center; color: #667eea;">
                        <div class="spinner" style="width: 20px; height: 20px; margin-right: 10px;"></div>
                        Modifying recipe based on your feedback...
                    </div>
                `;

                const response = await fetch(`${BASE_URL}/recommendations/recipe/modify`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        original_recipe: currentRecipe,
                        user_feedback: feedback,
                        analysis_data: currentData.analysis_data
                    })
                });

                if (!response.ok) {
                    throw new Error(`Recipe modification failed: ${response.status}`);
                }

                const data = await response.json();
                currentRecipe = data.recipe;
                recipeModificationCount++;

                // Update recipe content
                document.getElementById("recipe-content").innerHTML = formatMarkdown(data.recipe);
                
                // Clear feedback input
                document.getElementById("recipe-feedback-input").value = "";
                
                // Show success message
                document.getElementById("recipe-modification-status").innerHTML = `
                    <div style="color: #48bb78; font-weight: 600;">
                        âœ… Recipe modified successfully! (Modification #${recipeModificationCount})
                    </div>
                `;

                showMessage("system", "Recipe modified based on your feedback!", false);

            } catch (error) {
                console.error("Recipe modification error:", error);
                document.getElementById("recipe-modification-status").innerHTML = `
                    <div style="color: #e53e3e; font-weight: 600;">
                        âŒ Failed to modify recipe. Please try again.
                    </div>
                `;
                showMessage("system", "Failed to modify recipe: " + error.message, true);
            }
        });

        document.getElementById("recipe-satisfied-btn").addEventListener("click", () => {
            document.getElementById("recipe-modification-status").innerHTML = `
                <div style="color: #48bb78; font-weight: 600; text-align: center; padding: 15px; background: #f0fff4; border-radius: 8px; border: 1px solid #9ae6b4;">
                    ðŸŽ‰ Great! Your recipe is finalized. You can now save it or try the meal plan feature.
                </div>
            `;
            
            // Hide the feedback section
            document.getElementById("recipe-feedback-section").style.display = "none";
            
            showMessage("system", "Recipe finalized! You can now explore other features.", false);
        });

        // Update the original recipe generation to store the recipe
        const originalGetRecipeBtn = document.getElementById("get-recipe-btn");
        originalGetRecipeBtn.addEventListener("click", async () => {
            if (!currentData || !currentData.analysis_data || connectionStatus === 'offline') {
                showMessage("system", "No analysis data available for recipe generation", true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/recommendations/recipe`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(currentData.analysis_data)
                });

                if (!response.ok) {
                    throw new Error(`Recipe generation failed: ${response.status}`);
                }

                const data = await response.json();
                currentRecipe = data.recipe; // Store the recipe for modifications
                recipeModificationCount = 0; // Reset modification count
                
                document.getElementById("recipe-content").innerHTML = formatMarkdown(data.recipe);
                document.getElementById("recipe-section").classList.remove("hidden");
                
                // Show feedback section and reset status
                document.getElementById("recipe-feedback-section").style.display = "block";
                document.getElementById("recipe-modification-status").innerHTML = "";
                document.getElementById("recipe-feedback-input").value = "";
                
            } catch (error) {
                console.error("Recipe error:", error);
                showMessage("system", "Failed to generate recipe: " + error.message, true);
            }
        });

        // Floating Chatbot Functionality
        let floatingChatHistory = [];

        function toggleChatbot() {
            const chatWindow = document.getElementById("chatbot-window");
            chatWindow.classList.toggle("active");
        }

        document.getElementById("chatbot-toggle").addEventListener("click", toggleChatbot);

        document.getElementById("floating-chat-send").addEventListener("click", async () => {
            await sendFloatingChatMessage();
        });

        document.getElementById("floating-chat-input").addEventListener("keypress", async (e) => {
            if (e.key === 'Enter') {
                await sendFloatingChatMessage();
            }
        });

        async function sendFloatingChatMessage() {
            const input = document.getElementById("floating-chat-input");
            const message = input.value.trim();

            if (!message) return;

            if (connectionStatus === 'offline') {
                addFloatingChatMessage("System", "This feature requires an internet connection", "system");
                return;
            }

            input.value = "";
            addFloatingChatMessage("You", message, "user");

            try {
                const context = {
                    user_id: userId,
                    current_analysis: currentData?.analysis_data || null,
                    chat_history: floatingChatHistory.slice(-5) // Last 5 exchanges
                };

                const response = await fetch(`${BASE_URL}/agent/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: message,
                        context: context
                    })
                });

                if (!response.ok) {
                    throw new Error(`Chat failed: ${response.status}`);
                }

                const data = await response.json();
                addFloatingChatMessage("Health Coach", data.response, "bot");

                // Update floating chat history
                floatingChatHistory.push({
                    user: message,
                    agent: data.response
                });

                // Keep only last 10 exchanges
                if (floatingChatHistory.length > 10) {
                    floatingChatHistory = floatingChatHistory.slice(-10);
                }
            } catch (error) {
                console.error("Floating chat error:", error);
                addFloatingChatMessage("Health Coach", "Sorry, I'm having trouble responding right now. Please try again.", "bot");
            }
        }

        function addFloatingChatMessage(sender, message, type) {
            const container = document.getElementById("floating-chat-messages");
            const messageDiv = document.createElement("div");
            messageDiv.className = `chatbot-message ${type}`;

            if (type === "user") {
                messageDiv.innerHTML = `<strong>You:</strong><br>${message}`;
            } else if (type === "system") {
                messageDiv.innerHTML = `<strong>System:</strong><br>${message}`;
            } else {
                messageDiv.innerHTML = `<strong>${sender}:</strong><br>${message}`;
            }

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Dashboard Functionality
        async function loadTodayDashboard() {
            if (!userId || connectionStatus === 'offline') {
                document.getElementById("today-dashboard-content").innerHTML = "<p>Please login to view today's progress</p>";
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/dashboard/daily/${userId}`);
                if (!response.ok) {
                    throw new Error(`Dashboard failed: ${response.status}`);
                }

                const data = await response.json();
                displayTodayDashboard(data.data);
            } catch (error) {
                console.error("Today dashboard error:", error);
                document.getElementById("today-dashboard-content").innerHTML = "<p>Failed to load today's data</p>";
            }
        }

        function displayTodayDashboard(data) {
            const container = document.getElementById("today-dashboard-content");
            
            const goalCalories = data.goals?.calories || 2000;
            const goalProtein = data.goals?.protein || 50;
            const caloriesProgress = Math.min((data.total_calories / goalCalories) * 100, 100);
            const proteinProgress = Math.min((data.total_protein / goalProtein) * 100, 100);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px;">
                        <h4 style="margin: 0 0 10px 0;">Calories</h4>
                        <div style="font-size: 1.5em; font-weight: bold;">${data.total_calories || 0}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Goal: ${goalCalories}</div>
                        <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; margin-top: 8px;">
                            <div style="background: white; height: 100%; width: ${caloriesProgress}%; border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 15px; border-radius: 12px;">
                        <h4 style="margin: 0 0 10px 0;">Protein</h4>
                        <div style="font-size: 1.5em; font-weight: bold;">${data.total_protein || 0}g</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Goal: ${goalProtein}g</div>
                        <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; margin-top: 8px;">
                            <div style="background: white; height: 100%; width: ${proteinProgress}%; border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; padding: 15px; border-radius: 12px;">
                        <h4 style="margin: 0 0 10px 0;">Meals Today</h4>
                        <div style="font-size: 1.5em; font-weight: bold;">${data.meals_count || 0}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">${data.day_of_week || 'Today'}</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: white; padding: 15px; border-radius: 12px;">
                        <h4 style="margin: 0 0 10px 0;">Goals Status</h4>
                        <div style="font-size: 1.2em;">
                            ${data.goal_calories_achieved ? 'ðŸŽ¯' : 'â³'} Calories
                            ${data.goal_protein_achieved ? 'ðŸŽ¯' : 'â³'} Protein
                        </div>
                    </div>
                </div>
                
                ${data.meal_breakdown ? `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h5 style="margin-bottom: 10px;">Meal Breakdown</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <div><strong>Breakfast:</strong> ${data.meal_breakdown.breakfast?.calories || 0} cal</div>
                        <div><strong>Lunch:</strong> ${data.meal_breakdown.lunch?.calories || 0} cal</div>
                        <div><strong>Dinner:</strong> ${data.meal_breakdown.dinner?.calories || 0} cal</div>
                        <div><strong>Snacks:</strong> ${data.meal_breakdown.snack?.calories || 0} cal</div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        // Dashboard Tab Management
        document.getElementById("daily-tab").addEventListener("click", () => {
            switchDashboardTab("daily");
        });

        document.getElementById("weekly-tab").addEventListener("click", () => {
            switchDashboardTab("weekly");
        });

        document.getElementById("monthly-tab").addEventListener("click", () => {
            switchDashboardTab("monthly");
        });

        document.getElementById("goals-tab").addEventListener("click", () => {
            switchDashboardTab("goals");
        });

        document.getElementById("profile-tab").addEventListener("click", () => {
            switchDashboardTab("profile");
        });

        function switchDashboardTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Update content
            document.querySelectorAll('.dashboard-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(tabName + '-dashboard').classList.remove('hidden');
        }

        // Daily Dashboard
        document.getElementById("load-daily-btn").addEventListener("click", async () => {
            const dateInput = document.getElementById("daily-date-picker");
            const targetDate = dateInput.value;
            
            if (!userId) {
                showMessage("system", "Please login first", true);
                return;
            }

            try {
                let url = `${BASE_URL}/dashboard/daily/${userId}`;
                if (targetDate) {
                    url += `?target_date=${targetDate}`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Daily dashboard failed: ${response.status}`);
                }

                const data = await response.json();
                displayDailyResults(data.data);
            } catch (error) {
                console.error("Daily dashboard error:", error);
                showMessage("system", "Failed to load daily data: " + error.message, true);
            }
        });

        function displayDailyResults(data) {
            const container = document.getElementById("daily-results");
            
            container.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0;">
                    <h4 style="color: #4a5568; margin-bottom: 15px;">${data.date_formatted || data.date}</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="nutrition-stat">
                            <span>Total Calories:</span>
                            <strong>${data.total_calories || 0}</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Total Protein:</span>
                            <strong>${data.total_protein || 0}g</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Total Carbs:</span>
                            <strong>${data.total_carbs || 0}g</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Total Fat:</span>
                            <strong>${data.total_fat || 0}g</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Meals Count:</span>
                            <strong>${data.meals_count || 0}</strong>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <span style="padding: 5px 10px; border-radius: 15px; font-size: 0.9em; ${data.goal_calories_achieved ? 'background: #f0fff4; color: #38a169;' : 'background: #fef5e7; color: #ed8936;'}">
                            ${data.goal_calories_achieved ? 'âœ…' : 'â³'} Calorie Goal
                        </span>
                        <span style="padding: 5px 10px; border-radius: 15px; font-size: 0.9em; ${data.goal_protein_achieved ? 'background: #f0fff4; color: #38a169;' : 'background: #fef5e7; color: #ed8936;'}">
                            ${data.goal_protein_achieved ? 'âœ…' : 'â³'} Protein Goal
                        </span>
                    </div>
                </div>
            `;
        }

        // Weekly Dashboard
        document.getElementById("load-weekly-btn").addEventListener("click", async () => {
            if (!userId) {
                showMessage("system", "Please login first", true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/dashboard/weekly/${userId}`);
                if (!response.ok) {
                    throw new Error(`Weekly dashboard failed: ${response.status}`);
                }

                const data = await response.json();
                displayWeeklyResults(data.data);
            } catch (error) {
                console.error("Weekly dashboard error:", error);
                showMessage("system", "Failed to load weekly data: " + error.message, true);
            }
        });

        function displayWeeklyResults(data) {
            const container = document.getElementById("weekly-results");
            
            container.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0;">
                    <h4 style="color: #4a5568; margin-bottom: 15px;">Week of ${new Date(data.week_start).toLocaleDateString()} - ${new Date(data.week_end).toLocaleDateString()}</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="nutrition-stat">
                            <span>Avg Daily Calories:</span>
                            <strong>${data.averages?.calories || 0}</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Avg Daily Protein:</span>
                            <strong>${data.averages?.protein || 0}g</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Total Meals:</span>
                            <strong>${data.totals?.meals || 0}</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Days Tracked:</span>
                            <strong>${data.goal_achievement?.total_days || 0}/7</strong>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h5 style="margin-bottom: 10px;">Goal Achievement</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>Calorie Goals Met: <strong>${data.goal_achievement?.calories_days || 0}/${data.goal_achievement?.total_days || 0} days</strong></div>
                            <div>Protein Goals Met: <strong>${data.goal_achievement?.protein_days || 0}/${data.goal_achievement?.total_days || 0} days</strong></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h5 style="margin-bottom: 10px;">Daily Breakdown</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                            ${data.daily_data?.map(day => `
                                <div style="text-align: center; padding: 10px; background: ${day.calories > 0 ? '#f0fff4' : '#f8fafc'}; border-radius: 8px; border: 1px solid ${day.calories > 0 ? '#9ae6b4' : '#e2e8f0'};">
                                    <div style="font-weight: bold; font-size: 0.9em;">${day.day_name.substring(0, 3)}</div>
                                    <div style="font-size: 0.8em; margin: 5px 0;">${day.calories} cal</div>
                                    <div style="font-size: 0.7em;">${day.meals_count} meals</div>
                                </div>
                            `).join('') || '<p>No data available</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Monthly Dashboard
        document.getElementById("load-monthly-btn").addEventListener("click", async () => {
            if (!userId) {
                showMessage("system", "Please login first", true);
                return;
            }

            const month = document.getElementById("month-picker").value;
            const year = document.getElementById("year-picker").value;

            try {
                const response = await fetch(`${BASE_URL}/dashboard/monthly/${userId}?month=${month}&year=${year}`);
                if (!response.ok) {
                    throw new Error(`Monthly dashboard failed: ${response.status}`);
                }

                const data = await response.json();
                displayMonthlyResults(data.data);
            } catch (error) {
                console.error("Monthly dashboard error:", error);
                showMessage("system", "Failed to load monthly data: " + error.message, true);
            }
        });

        function displayMonthlyResults(data) {
            const container = document.getElementById("monthly-results");
            
            container.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #e2e8f0;">
                    <h4 style="color: #4a5568; margin-bottom: 15px;">${data.month_name} ${data.year}</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="nutrition-stat">
                            <span>Avg Daily Calories:</span>
                            <strong>${data.averages?.calories || 0}</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Avg Daily Protein:</span>
                            <strong>${data.averages?.protein || 0}g</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Total Meals:</span>
                            <strong>${data.totals?.meals || 0}</strong>
                        </div>
                        <div class="nutrition-stat">
                            <span>Days Tracked:</span>
                            <strong>${data.days_tracked}/${data.days_in_month}</strong>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h5 style="margin-bottom: 10px;">Monthly Goal Achievement</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div>Calorie Goals: <strong>${data.goal_achievement?.calories_percentage || 0}%</strong></div>
                                <div style="background: #e2e8f0; height: 6px; border-radius: 3px; margin-top: 5px;">
                                    <div style="background: #48bb78; height: 100%; width: ${data.goal_achievement?.calories_percentage || 0}%; border-radius: 3px;"></div>
                                </div>
                            </div>
                            <div>
                                <div>Protein Goals: <strong>${data.goal_achievement?.protein_percentage || 0}%</strong></div>
                                <div style="background: #e2e8f0; height: 6px; border-radius: 3px; margin-top: 5px;">
                                    <div style="background: #667eea; height: 100%; width: ${data.goal_achievement?.protein_percentage || 0}%; border-radius: 3px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${data.weekly_data?.length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h5 style="margin-bottom: 10px;">Weekly Breakdown</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                            ${data.weekly_data.map(week => `
                                <div style="text-align: center; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="font-weight: bold; font-size: 0.9em;">Week ${week.week_number}</div>
                                    <div style="font-size: 0.8em; margin: 5px 0;">${week.calories} cal</div>
                                    <div style="font-size: 0.7em;">${week.meals} meals</div>
                                    <div style="font-size: 0.7em;">${week.days_tracked} days</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Goals Management
        document.getElementById("save-goals-btn").addEventListener("click", async () => {
            if (!userId) {
                showMessage("system", "Please login first", true);
                return;
            }

            const goals = {
                calories: parseInt(document.getElementById("goal-calories").value) || 2000,
                protein: parseInt(document.getElementById("goal-protein").value) || 50,
                carbs: parseInt(document.getElementById("goal-carbs").value) || 250,
                fat: parseInt(document.getElementById("goal-fat").value) || 65,
                fiber: parseInt(document.getElementById("goal-fiber").value) || 25
            };

            try {
                const response = await fetch(`${BASE_URL}/dashboard/goals/${userId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(goals)
                });

                if (!response.ok) {
                    throw new Error(`Goals update failed: ${response.status}`);
                }

                showMessage("system", "Goals updated successfully!", false);
                
                // Refresh today's dashboard
                loadTodayDashboard();
            } catch (error) {
                console.error("Goals update error:", error);
                showMessage("system", "Failed to update goals: " + error.message, true);
            }
        });

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Initializing application...");

            // Test connection
            const connected = await testConnection();
            if (!connected) {
                console.warn("Starting in offline mode");
                return;
            }

            // Initialize session
            if (!sessionId) {
                await initSession();
            }

            // Set current date in date picker
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("daily-date-picker").value = today;
            
            // Set current month and year
            const now = new Date();
            document.getElementById("month-picker").value = now.getMonth() + 1;
            document.getElementById("year-picker").value = now.getFullYear();

            // Restore user session
            const storedUserId = localStorage.getItem('userId');
            if (storedUserId) {
                userId = parseInt(storedUserId);
                document.getElementById('current-user').textContent = `User ID: ${userId}`;
                document.getElementById('nav-header').classList.remove('hidden');
                showPage('dashboard');
                loadUserInsights();
                loadTodayDashboard();

                try {
                    const response = await fetch(`${BASE_URL}/users/${userId}`);
                    if (response.ok) {
                        const user = await response.json();
                        document.getElementById('current-user').textContent = user.name || user.email || `User ID: ${userId}`;
                        loadProfile(user.profile);
                        loadUserInsights();
                        
                        // Load user goals if available
                        if (user.daily_goals) {
                            document.getElementById("goal-calories").value = user.daily_goals.calories || 2000;
                            document.getElementById("goal-protein").value = user.daily_goals.protein || 50;
                            document.getElementById("goal-carbs").value = user.daily_goals.carbs || 250;
                            document.getElementById("goal-fat").value = user.daily_goals.fat || 65;
                            document.getElementById("goal-fiber").value = user.daily_goals.fiber || 25;
                        }
                    }
                } catch (error) {
                    console.error("Failed to load user data:", error);
                }
            } else {
                showPage('login');
            }

            // Set up periodic connection check
            setInterval(testConnection, 30000); // Check every 30 seconds
        });
    </script>
</body>

</html>
